<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mission List</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&family=Shippori+Mincho:wght@500;700&family=Zen+Kaku+Gothic+New:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="images/icon-192.png"> <meta name="theme-color" content="#0f172a"> 
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script src="data/word_data.js"></script>
    <script src="js/app.js"></script>
    

    <style>
        body { 
            background: #0f172a; 
            color: white; 
            /* 1è¡Œã«ã¾ã¨ã‚ã¾ã—ãŸ */
            font-family: 'Montserrat', 'Zen Kaku Gothic New', sans-serif;
            opacity: 0; 
            transition: opacity 0.3s ease-in-out; 
        }
        body.loaded {
            opacity: 1; 
        }

        /* æ—¢å­˜ã®JSã‚³ãƒ¼ãƒ‰ãŒ .jp-font ã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆã€ã“ã®ã‚¯ãƒ©ã‚¹åã‚’ç¶­æŒã™ã‚‹ã®ãŒé‡è¦ã§ã™ */
        .jp-font, .jp-font-serif { 
            font-family: 'Shippori Mincho', serif; 
        }
        
        /* ã‚«ãƒ¼ãƒ‰ã®ãƒ›ãƒãƒ¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãªã©ã€æ—¢å­˜ã®ã‚¹ã‚¿ã‚¤ãƒ«ã¯ãã®ã¾ã¾ç¶­æŒ */
        .word-card:active { transform: scale(0.98); }

        /* éŸ³é‡ãƒœã‚¿ãƒ³ */
        .vol-btn { background: #334155; transition: all 0.2s; }
        .vol-btn.active { background: #00f2ff; box-shadow: 0 0 10px #00f2ff; }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }

        .section-anchor {
            scroll-margin-top: 100px; /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®é«˜ã•åˆ† */
        }

        /* ç¸¦å‹ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        #alphabet-nav-vertical {
            position: fixed;
            top: 50%;
            right: 0;
            transform: translateY(-50%);
            z-index: 30;
            
            /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ */
            display: flex;
            flex-direction: column;
            align-items: center;     /* æ–‡å­—ã‚’å·¦å³ä¸­å¤®æƒãˆ */
            justify-content: center; /* ä¸Šä¸‹ä¸­å¤®æƒãˆ */
            gap: 1px;                /* æ–‡å­—é–“éš”ã‚’å°‘ã—è©°ã‚ã‚‹ */
            
            /* ã‚µã‚¤ã‚ºèª¿æ•´: pr-10 (40px) ã«åˆã‚ã›ã¦èª¿æ•´ */
            width: 36px;             /* ã‚«ãƒ¼ãƒ‰ã¨ã®éš™é–“4pxã‚’ç¢ºä¿ */
            padding: 12px 0;         /* ä¸Šä¸‹ã®ä½™ç™½ */
            
            /* è¦‹ãŸç›®ã®èª¿æ•´ */
            background-color: rgba(15, 23, 42, 0.85); /* èƒŒæ™¯ã‚’å°‘ã—æ¿ƒã */
            backdrop-filter: blur(10px);
            border-radius: 8px 0 0 8px;
            border-left: 1px solid rgba(255, 255, 255, 0.1); /* å¢ƒç•Œç·šã‚’è¿½åŠ ã—ã¦è¦–èªæ€§ã‚¢ãƒƒãƒ— */
            box-shadow: -4px 0 10px rgba(0, 0, 0, 0.3);      /* ç«‹ä½“æ„Ÿã‚’è¿½åŠ  */
        }

        #alphabet-nav-vertical a {
            display: block;
            width: 100%;             /* æ¨ªå¹…ã„ã£ã±ã„ã«åºƒã’ã¦ã‚¿ãƒƒãƒ—ã—ã‚„ã™ã */
            text-align: center;
            font-size: 14px;         /* èª­ã¿ã‚„ã™ã„ã‚µã‚¤ã‚ºã«å¾®èª¿æ•´ */
            line-height: 1.6;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            color: #64748b;          /* é€šå¸¸æ™‚ã¯å°‘ã—æš—ã‚ */
            transition: all 0.15s ease-out;
            padding: 1px 0;
        }
    </style>
</head>
<body class="p-4 pb-20 select-none">

    <!-- BGMå†ç”Ÿç”¨ã®audioè¦ç´  -->
    <audio id="bgm" loop></audio>

    <header class="sticky top-0 bg-[#0f172a]/95 backdrop-blur-md z-20 py-4 mb-4 border-b border-slate-700 flex justify-between items-center">
        <div class="flex items-center gap-4">
            <button onclick="goTo('index.html')" class="text-gray-400 hover:text-white transition">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                </svg>
            </button>
            <h2 class="text-xl font-black tracking-widest text-cyan-400">MISSION LIST</h2>
        </div>
        <div class="flex items-center gap-6">
            <div class="text-right">
                <div id="user-info" class="hidden items-center gap-3 text-xs">
                    <span id="user-email" class="text-gray-400 font-mono"></span>
                    <button onclick="logout()" class="px-2 py-1 border border-red-500/50 text-red-400 rounded hover:bg-red-500/20 transition-colors text-xs tracking-widest">
                        LOGOUT
                    </button>
                </div>
                <div class="text-xs text-gray-400 font-mono mt-1" id="total-progress">LOADING...</div>
            </div>
        </div>
    </header>

    <!-- Alphabet Navigation -->
    <div id="alphabet-nav-vertical">
        <!-- Links will be generated by JavaScript -->
    </div>

    <div id="list-container" class="space-y-3 max-w-2xl mx-auto pr-10">
        </div>
<div id="premium-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center px-4">
    <div class="absolute inset-0 bg-slate-900/90 backdrop-blur-sm" onclick="closePremiumModal()"></div>
    
    <div class="relative bg-slate-800 border border-cyan-500/30 rounded-2xl shadow-[0_0_50px_rgba(6,182,212,0.2)] max-w-sm w-full p-8 text-center overflow-hidden">
        
        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-cyan-500 to-purple-600"></div>
        <div class="absolute -top-10 -right-10 w-32 h-32 bg-cyan-500/10 rounded-full blur-2xl"></div>

        <div class="mx-auto w-16 h-16 bg-slate-700 rounded-full flex items-center justify-center mb-6 border border-slate-600 shadow-inner">
            <span class="text-3xl">ğŸ’</span>
        </div>

        <h2 class="text-2xl font-black text-white mb-2 tracking-wider">UNLOCK ALL DATA</h2>
        <p class="text-slate-400 text-sm mb-8 leading-relaxed jp-font">
            æœ€åˆã®50èªã‚’çªç ´ã—ãŸèƒ½åŠ›è€…ã¸ã€‚<br>
            å…¨680èªã®å°å°ã‚’è§£é™¤ã—ã€<br>
            å®Œå…¨ãªãƒœã‚­ãƒ£ãƒ–ãƒ©ãƒªãƒ¼ã‚’æ‰‹ã«å…¥ã‚Œã‚ã€‚
        </p>

        <button id="checkout-button" onclick="startCheckout()" class="block w-full bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white font-bold py-4 px-6 rounded-xl shadow-lg transform transition active:scale-95 mb-1 tracking-widest">
    UNLOCK NOW (Â¥150)
</button>

<div id="loading-msg" class="hidden text-xs text-cyan-400 animate-pulse mt-2 mb-6">
    Connecting to Stripe...
</div>

<button onclick="closePremiumModal()" class="text-slate-500 text-xs hover:text-white transition tracking-widest">
    CLOSE
</button>
    </div>
</div>
    <script>
    // --- è¨­å®šå€¤ ---
    const FREE_LIMIT = 50; // ç„¡æ–™ã§éŠã¹ã‚‹å˜èªæ•°
    let isUserPremium = false; // èª²é‡‘çŠ¶æ…‹ï¼ˆåˆæœŸå€¤falseï¼‰
    let unsubscribePaymentListener = null;
    // list.htmlå°‚ç”¨ã®åˆæœŸåŒ–é–¢æ•°
    // ä¿®æ­£å¯¾è±¡: initializePage é–¢æ•°å…¨ä½“ã‚’ä»¥ä¸‹ã«ç½®ãæ›ãˆ
async function initializePage() {
    // å¸¸ã«æœ€æ–°ã®é€²æ—ã‚’èª­ã¿è¾¼ã‚“ã§ã‹ã‚‰å‡¦ç†ã‚’é–‹å§‹
    await loadAllProgress();

    // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹å ´åˆã€UIã‚’æ›´æ–°
    if (currentUser) {
        updateUserUI(currentUser);
        
        // 1. ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—
        const wasPremium = isUserPremium; // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰å‰ã®çŠ¶æ…‹ï¼ˆåˆæœŸå€¤falseï¼‰
        isUserPremium = await checkPremiumStatus(currentUser.uid);
        
        console.log("User Premium Status:", isUserPremium);

        // 2. Stripeã‹ã‚‰ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒ•ãƒ©ã‚°ã‚’å–å¾—
        const justPaid = sessionStorage.getItem('is_checkout_redirect') === 'true';

        if (isUserPremium && justPaid) {
            // ã€æ¼”å‡ºãƒˆãƒªã‚¬ãƒ¼ã€‘: èª²é‡‘ãŒæˆåŠŸã—ã€Stripeã‹ã‚‰æˆ»ã£ã¦ããŸç›´å¾Œ
            
            // ãƒ•ãƒ©ã‚°ã‚’å‰Šé™¤ (äºŒé‡å®Ÿè¡Œã‚’é˜²ã)
            sessionStorage.removeItem('is_checkout_redirect');

            // æ¼”å‡ºã‚’é–‹å§‹ã—ã€è§£é™¤å‡¦ç†ã¯æ¼”å‡ºã«ä»»ã›ã‚‹
            triggerUnlockSequence(); 
            return; // â˜…é‡è¦: ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã¯ã“ã“ã§å‡¦ç†ã‚’ä¸­æ–­

        } else if (!isUserPremium) {
            // æœªèª²é‡‘çŠ¶æ…‹ã®å ´åˆã®ã¿ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã‚’é–‹å§‹
            setupRealtimePaymentListener(currentUser.uid);
        }
    }
    
    // 3. é€šå¸¸æ™‚ã€ã¾ãŸã¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒä¸è¦ãªå ´åˆã¯ã“ã“ã§æç”»
    renderList();
}
    function setupRealtimePaymentListener(uid) {
        // customers/{uid}/payments ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç›£è¦–
        unsubscribePaymentListener = db.collection('customers')
            .doc(uid)
            .collection('payments')
            .where('status', '==', 'succeeded')
            .onSnapshot((snapshot) => {
                // æˆåŠŸãƒ‡ãƒ¼ã‚¿ãŒè¿½åŠ ã•ã‚ŒãŸã‚‰ç™ºå‹•
                if (!snapshot.empty) {
                    console.log("Payment detected via Stream!");
                    triggerUnlockSequence(); // æ¼”å‡ºé–‹å§‹
                    
                    // ç›£è¦–ã‚’çµ‚äº†ï¼ˆã‚‚ã†å¿…è¦ãªã„ã®ã§ï¼‰
                    if (unsubscribePaymentListener) unsubscribePaymentListener();
                }
            });
    }

    // ã€è¿½åŠ ã€‘æ¼”å‡ºã¨ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚’å®Ÿè¡Œã™ã‚‹é–¢æ•°
    function triggerUnlockSequence() { // â˜…â˜…â˜… ã“ã®é–¢æ•°ã§ã™ â˜…â˜…â˜…
        // 1. ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        closePremiumModal();

        // 2. æ¼”å‡ºãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¡¨ç¤º
        const overlay = document.getElementById('unlock-overlay');
        const bar = document.getElementById('unlock-progress-bar');
        overlay.classList.remove('hidden');

        // 3. ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’ä¼¸ã°ã™æ¼”å‡º
        setTimeout(() => { bar.style.width = '100%'; }, 100);

        // 4. æ•°ç§’å¾Œã«æ¼”å‡ºã‚’æ¶ˆã—ã¦ã€ãƒªã‚¹ãƒˆã‚’å†æç”»ï¼ˆãƒ­ãƒƒã‚¯è§£é™¤ï¼‰
        setTimeout(() => {
            isUserPremium = true; // ãƒ•ãƒ©ã‚°ã‚’å¼·åˆ¶çš„ã«ON
            renderList(); // ãƒªã‚¹ãƒˆã‚’å†æç”»ï¼ˆã“ã‚Œã§éµãŒæ¶ˆãˆã‚‹ï¼‰
            
            // æ¼”å‡ºçµ‚äº†
            overlay.classList.add('hidden');
            overlay.classList.remove('flex');
            
            // å¿…è¦ãªã‚‰ã“ã“ã«ã€ŒBGMã‚’å¤‰ãˆã‚‹ã€ãªã©ã®å‡¦ç†ã‚‚è¿½åŠ å¯èƒ½
        }, 3500); // ğŸ‘ˆ ã“ã®æ™‚é–“ã‚’èª¿æ•´ã—ã¾ã—ãŸ

    }
    
    function renderList() {
        const container = document.getElementById('list-container');
        const navContainer = document.getElementById('alphabet-nav-vertical');
        container.innerHTML = ''; // ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¯ãƒªã‚¢
        navContainer.innerHTML = ''; // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢

        let masteredCount = 0;

        // ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã”ã¨ã«å˜èªã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
        const groupedWords = WORD_DATABASE.reduce((acc, word) => {
            const firstLetter = word.word.charAt(0).toUpperCase();
            if (!acc[firstLetter]) {
                acc[firstLetter] = [];
            }
            acc[firstLetter].push(word);
            return acc;
        }, {});

        // ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †ã«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¨ã‚«ãƒ¼ãƒ‰ã‚’æç”»
        Object.keys(groupedWords).sort().forEach(letter => {
            // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒªãƒ³ã‚¯ã‚’ä½œæˆ
            const navLink = document.createElement('a');
            navLink.href = `#section-${letter}`;
            navLink.textContent = letter.toUpperCase();
            navLink.className = 'hover:text-cyan-400';
            navLink.onclick = (e) => {
                e.preventDefault();
                document.querySelector(navLink.getAttribute('href')).scrollIntoView({ behavior: 'smooth' });
            };
            navContainer.appendChild(navLink);

            // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä½œæˆ
            const sectionWrapper = document.createElement('div');
            sectionWrapper.id = `section-${letter}`;
            sectionWrapper.className = 'section-anchor';
            
            const header = document.createElement('h3');
            header.className = 'text-2xl font-black text-slate-600 tracking-widest mb-3 ml-1';
            header.textContent = letter;
            sectionWrapper.appendChild(header);
            
            // å„å˜èªã‚«ãƒ¼ãƒ‰ã‚’æç”»
            groupedWords[letter].forEach(word => {
                // â˜…ãƒ­ãƒƒã‚¯åˆ¤å®š
                const isLocked = (word.id > FREE_LIMIT) && !isUserPremium;

                // --- ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹å ´åˆã®è¡¨ç¤º ---
                if (isLocked) {
                    const div = document.createElement('div');
                    // å°‘ã—æš—ãã€å½©åº¦ã‚’è½ã¨ã—ãŸã‚¹ã‚¿ã‚¤ãƒ«
                    div.className = `word-card relative p-4 rounded-xl border border-slate-800 bg-slate-900/50 cursor-pointer transition-all overflow-hidden group mb-3 hover:border-purple-500/50`;
                    
                    // ã‚¯ãƒªãƒƒã‚¯ã§èª²é‡‘ãƒ¢ãƒ¼ãƒ€ãƒ«ã¸
                    div.onclick = () => openPremiumModal();

                    div.innerHTML = `
                        <div class="flex justify-between items-center relative z-10 opacity-60">
                            <div class="flex items-center gap-3">
                                <div class="text-xl text-slate-600">ğŸ”’</div>
                                <div>
                                    <div class="text-xl font-bold tracking-wide text-slate-500 filter blur-[2px] select-none">LOCKED</div>
                                    <div class="text-sm text-slate-600 jp-font mt-1">Premium Only</div>
                                </div>
                            </div>
                            <div class="text-right pl-4">
                                <div class="text-[10px] font-mono text-slate-700 mb-1 tracking-wider">ID</div>
                                <div class="text-lg font-bold font-mono text-slate-700">
                                    ${word.id}
                                </div>
                            </div>
                        </div>
                    `;
                    sectionWrapper.appendChild(div);

                // --- è§£æ”¾ã•ã‚Œã¦ã„ã‚‹å ´åˆï¼ˆæ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ï¼‰ ---
                } else {
                    const progress = getProgress(word.id);
                    let clearCount = 0;
                    if (typeof GAME_MODES !== 'undefined') {
                        clearCount = GAME_MODES.filter(m => progress[m.id]).length;
                    }

                    const isMastered = clearCount === 5;
                    if (isMastered) masteredCount++;

                    const progressPercent = (clearCount / 5) * 100;
                    
                    let borderClass = 'border-slate-700';
                    let bgClass = 'bg-slate-800';
                    let textClass = 'text-white';

                    if (isMastered) {
                        borderClass = 'border-cyan-500';
                        bgClass = 'bg-cyan-900/20';
                        textClass = 'text-cyan-300';
                    } else if (clearCount > 0) {
                        borderClass = 'border-slate-600';
                        bgClass = 'bg-slate-700/50';
                    }

                    const div = document.createElement('div');
                    div.className = `word-card relative p-4 rounded-xl border ${borderClass} ${bgClass} cursor-pointer transition-all overflow-hidden group mb-3`;
                    
                    div.onclick = () => goTo('cockpit.html', word.id);
                    const reviewButtonHtml = isMastered ? `
                        <button onclick="event.stopPropagation(); window.location.href = 'review.html?id=${word.id}'" 
                                class="p-2 mr-2 text-cyan-400 hover:text-white hover:scale-110 transition rounded-full bg-cyan-900/30 border border-cyan-500/30" 
                                title="Review Word">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                            </svg>
                        </button>
                    ` : '';
                    div.innerHTML = `
                        <div class="flex justify-between items-center relative z-10">
                            
                            <div class="flex-1 min-w-0 pr-2"> <div class="text-xl font-bold tracking-wide truncate ${textClass}">${word.word}</div>
                                <div class="text-sm text-gray-400 jp-font mt-1 truncate">${word.meaning_core}</div>
                            </div>

                            <div class="flex items-center shrink-0">
                                ${reviewButtonHtml}

                                <div class="text-right pl-2 border-l border-slate-600/50 ml-2">
                                    <div class="text-[10px] font-mono text-gray-500 mb-1 tracking-wider">CLEAR</div>
                                    <div class="text-lg font-bold font-mono ${isMastered ? 'text-cyan-400' : 'text-gray-600'}">
                                        ${clearCount}<span class="text-xs text-gray-600">/5</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="absolute bottom-0 left-0 h-1 bg-gradient-to-r from-cyan-500 to-purple-500 transition-all duration-1000" style="width: ${progressPercent}%"></div>
                    `;
                    sectionWrapper.appendChild(div);
                }
            });

            container.appendChild(sectionWrapper);
        });

        // å…¨ä½“é€²æ—æ›´æ–°
        document.getElementById('total-progress').textContent = `${masteredCount} / ${WORD_DATABASE.length} MASTERED`;

        setupInteractiveNav();
    }

    function setupInteractiveNav() {
        const nav = document.getElementById('alphabet-nav-vertical');
        const links = Array.from(nav.getElementsByTagName('a'));
        if (links.length === 0) return;

        let activeLink = null;

        const updateActiveLink = (y) => {
            let closestLink = null;
            let minDistance = Infinity;

            links.forEach(link => {
                const linkRect = link.getBoundingClientRect();
                const linkCenterY = linkRect.top + linkRect.height / 2;
                const distance = Math.abs(y - linkCenterY);

                if (distance < minDistance) {
                    minDistance = distance;
                    closestLink = link;
                }
            });

            if (activeLink !== closestLink) {
                if (activeLink) {
                    activeLink.style.transform = 'scale(1)';
                    activeLink.style.color = '';
                }
                if (closestLink) {
                    closestLink.style.transform = 'scale(2.2)';
                    closestLink.style.color = '#22d3ee'; 
                }
                activeLink = closestLink;
            }
        };

        const resetStyles = () => {
            if (activeLink) {
                activeLink.style.transform = 'scale(1)';
                activeLink.style.color = '';
                activeLink = null;
            }
        };

        nav.addEventListener('mousemove', (e) => updateActiveLink(e.clientY));
        nav.addEventListener('mouseleave', resetStyles);
        nav.addEventListener('touchmove', (e) => { updateActiveLink(e.touches[0].clientY); }, { passive: true });
        nav.addEventListener('touchend', resetStyles);
    }

    // --- ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡ ---
    function openPremiumModal() {
        document.getElementById('premium-modal').classList.remove('hidden');
    }

    function closePremiumModal() {
        document.getElementById('premium-modal').classList.add('hidden');
    }

    // --- Stripeæ±ºæ¸ˆé–‹å§‹å‡¦ç† ---
async function startCheckout() {
    // â˜…â˜…â˜…ã“ã“ã‚’è¿½åŠ â˜…â˜…â˜…
    sessionStorage.setItem('is_checkout_redirect', 'true'); 
    
    // ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
    if (!currentUser) {
        alert("Please login first to save your progress.");
        return;
    }

    const btn = document.getElementById('checkout-button');
    const msg = document.getElementById('loading-msg');
    
    // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã¦ãƒ­ãƒ¼ãƒ‰ä¸­è¡¨ç¤º
    btn.disabled = true;
    btn.classList.add('opacity-50', 'cursor-not-allowed');
    msg.classList.remove('hidden');

    try {
        // 1. Firestoreã«ã€Œã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆä¾é ¼ã€ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä½œã‚‹
        // æ‹¡å¼µæ©Ÿèƒ½ãŒã“ã‚Œã‚’æ¤œçŸ¥ã—ã¦ã€Stripeã®æ±ºæ¸ˆURLã‚’ç™ºè¡Œã—ã¦ãã‚Œã¾ã™
        const docRef = await db.collection('customers') // app.jsã§dbãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹å‰æ(firebase.firestore())
            .doc(currentUser.uid)
            .collection('checkout_sessions')
            .add({
                // â˜…é‡è¦: Stripeã®å•†å“ãƒšãƒ¼ã‚¸ã«ã‚ã‚‹ã€ŒAPI IDã€ã‚’ã“ã“ã«è²¼ã‚‹
                price: 'price_1SWqmn5cwOK3M0Cgo5iONhSZ', 
                success_url: window.location.href, // æˆåŠŸã—ãŸã‚‰ä»Šã®ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹
                cancel_url: window.location.href,
                mode: 'payment'
            });

        // 2. æ‹¡å¼µæ©Ÿèƒ½ãŒ url ã‚’æ›¸ãè¾¼ã‚“ã§ãã‚Œã‚‹ã®ã‚’å¾…ã¤
        docRef.onSnapshot((snap) => {
            const { error, url } = snap.data();
            if (error) {
                console.error('An error occurred:', error.message);
                alert('Error: ' + error.message);
                btn.disabled = false;
                msg.classList.add('hidden');
            }
            if (url) {
                // 3. URLãŒã§ããŸã‚‰ãã“ã«é£›ã°ã™ï¼ˆStripeæ±ºæ¸ˆç”»é¢ã¸ï¼‰
                window.location.assign(url);
            }
        });

    } catch (e) {
        console.error(e);
        alert("Checkout failed to start: " + e.message);
        btn.disabled = false;
        msg.classList.add('hidden');
    }
}


</script>

<div id="unlock-overlay" class="hidden fixed inset-0 z-[100] bg-[#0f172a] h-screen w-screen overflow-hidden transition-opacity duration-1000 flex flex-col items-center justify-center">
        
        <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-cyan-500/40 via-blue-900/20 to-transparent opacity-0 animate-light-explode pointer-events-none"></div>
        
        <div class="absolute inset-[-100%] bg-[conic-gradient(from_0deg_at_50%_50%,_transparent_0deg,_rgba(34,211,238,0.1)_30deg,_transparent_60deg,_rgba(34,211,238,0.1)_90deg,_transparent_120deg,_rgba(34,211,238,0.1)_150deg,_transparent_180deg,_rgba(34,211,238,0.1)_210deg,_transparent_240deg,_rgba(34,211,238,0.1)_270deg,_transparent_300deg,_rgba(34,211,238,0.1)_330deg,_transparent_360deg)] animate-slow-spin opacity-50 pointer-events-none"></div>

        <div class="z-10 absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center w-full px-4">
            
            <div class="text-cyan-300 font-mono text-sm tracking-[0.8em] mb-8 opacity-0 animate-fade-in-up" style="animation-delay: 0.5s;">SYSTEM AUTHORIZED</div>
            
            <h1 class="text-5xl md:text-7xl font-black text-white tracking-tighter opacity-0 animate-holy-reveal whitespace-nowrap"
                style="text-shadow: 0 0 10px rgba(34,211,238,0.8), 0 0 30px rgba(34,211,238,0.6), 0 0 60px rgba(34,211,238,0.4), 0 0 100px rgba(59,130,246,0.3);">
                LOCK REMOVED
            </h1>

            <div class="mt-10 h-1 w-0 mx-auto rounded-full relative overflow-hidden bg-blue-900/30 max-w-xs" id="unlock-progress-container">
                <div id="unlock-progress-bar" class="absolute inset-0 w-0 bg-gradient-to-r from-cyan-400 via-white to-cyan-400 transition-all duration-1500 ease-out shadow-[0_0_20px_cyan]"></div>
            </div>
        </div>
    </div>

    <style>
        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®šç¾©ï¼ˆå¤‰æ›´ãªã—ï¼‰ */
        @keyframes light-explode {
            0% { opacity: 0; transform: scale(0.5); }
            50% { opacity: 1; transform: scale(1.2); }
            100% { opacity: 0; transform: scale(1.5); }
        }
        .animate-light-explode { animation: light-explode 3s ease-out forwards; }

        @keyframes slow-spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-slow-spin { animation: slow-spin 60s linear infinite; }

        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up { animation: fade-in-up 1s ease-out forwards; }

        @keyframes holy-reveal {
            0% { opacity: 0; transform: translateY(40px) scale(0.9); filter: blur(10px); }
            100% { opacity: 1; transform: translateY(0) scale(1); filter: blur(0px); }
        }
        .animate-holy-reveal { animation: holy-reveal 1.2s cubic-bezier(0.22, 1, 0.36, 1) forwards; animation-delay: 0.8s; }
    </style>
    
</body>
</html>