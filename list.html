<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mission List</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;900&family=Shippori+Mincho:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="/manifest.json">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script src="data/word_data.js"></script>
    <script src="js/app.js"></script>
    

    <style>
        body { 
            background: #0f172a; color: white; font-family: 'Montserrat', sans-serif; 
            opacity: 0; /* åˆæœŸçŠ¶æ…‹ã¯é€æ˜ */
            transition: opacity 0.3s ease-in-out; 
        }
        body.loaded {
            opacity: 1; /* èª­ã¿è¾¼ã¿å®Œäº†ã§è¡¨ç¤º */
        }
        .jp-font { font-family: 'Shippori Mincho', serif; }
        
        /* ã‚«ãƒ¼ãƒ‰ã®ãƒ›ãƒãƒ¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .word-card:active { transform: scale(0.98); }

        /* éŸ³é‡ãƒœã‚¿ãƒ³ */
        .vol-btn { background: #334155; transition: all 0.2s; }
        .vol-btn.active { background: #00f2ff; box-shadow: 0 0 10px #00f2ff; }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }

        .section-anchor {
            scroll-margin-top: 100px; /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®é«˜ã•åˆ† */
        }

        /* ç¸¦å‹ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        #alphabet-nav-vertical {
            position: fixed;
            top: 50%;
            right: 0;
            transform: translateY(-50%);
            z-index: 30; /* ä»–ã®è¦ç´ ã‚ˆã‚Šæ‰‹å‰ã« */
            display: flex;
            flex-direction: column;
            gap: 1px;
            padding: 8px 6px 8px 8px;
            background-color: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(8px);
            border-radius: 8px 0 0 8px;
        }

        #alphabet-nav-vertical a {
            font-size: 12px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            letter-spacing: 0.1em;
            color: #94a3b8;
            transition: transform 0.15s ease-out, color 0.15s ease-out;
            transform-origin: center right; /* å³ç«¯ã‚’åŸºç‚¹ã«æ‹¡å¤§ */
            padding: 2px 0;
        }
    </style>
</head>
<body class="p-4 pb-20 select-none">

    <!-- BGMå†ç”Ÿç”¨ã®audioè¦ç´  -->
    <audio id="bgm" loop></audio>

    <header class="sticky top-0 bg-[#0f172a]/95 backdrop-blur-md z-20 py-4 mb-4 border-b border-slate-700 flex justify-between items-center">
        <div class="flex items-center gap-4">
            <button onclick="goTo('index.html')" class="text-gray-400 hover:text-white transition">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                </svg>
            </button>
            <h2 class="text-xl font-black tracking-widest text-cyan-400">MISSION LIST</h2>
        </div>
        <div class="flex items-center gap-6">
            <div class="text-right">
                <div id="user-info" class="hidden items-center gap-3 text-xs">
                    <span id="user-email" class="text-gray-400 font-mono"></span>
                    <button onclick="logout()" class="px-2 py-1 border border-red-500/50 text-red-400 rounded hover:bg-red-500/20 transition-colors text-xs tracking-widest">
                        LOGOUT
                    </button>
                </div>
                <div class="text-xs text-gray-400 font-mono mt-1" id="total-progress">LOADING...</div>
            </div>
        </div>
    </header>

    <!-- Alphabet Navigation -->
    <div id="alphabet-nav-vertical">
        <!-- Links will be generated by JavaScript -->
    </div>

    <div id="list-container" class="space-y-3 max-w-2xl mx-auto">
        </div>
<div id="premium-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center px-4">
    <div class="absolute inset-0 bg-slate-900/90 backdrop-blur-sm" onclick="closePremiumModal()"></div>
    
    <div class="relative bg-slate-800 border border-cyan-500/30 rounded-2xl shadow-[0_0_50px_rgba(6,182,212,0.2)] max-w-sm w-full p-8 text-center overflow-hidden">
        
        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-cyan-500 to-purple-600"></div>
        <div class="absolute -top-10 -right-10 w-32 h-32 bg-cyan-500/10 rounded-full blur-2xl"></div>

        <div class="mx-auto w-16 h-16 bg-slate-700 rounded-full flex items-center justify-center mb-6 border border-slate-600 shadow-inner">
            <span class="text-3xl">ğŸ’</span>
        </div>

        <h2 class="text-2xl font-black text-white mb-2 tracking-wider">UNLOCK ALL DATA</h2>
        <p class="text-slate-400 text-sm mb-8 leading-relaxed jp-font">
            æœ€åˆã®50èªã‚’çªç ´ã—ãŸèƒ½åŠ›è€…ã¸ã€‚<br>
            å…¨680èªã®å°å°ã‚’è§£é™¤ã—ã€<br>
            å®Œå…¨ãªãƒœã‚­ãƒ£ãƒ–ãƒ©ãƒªãƒ¼ã‚’æ‰‹ã«å…¥ã‚Œã‚ã€‚
        </p>

        <button id="checkout-button" onclick="startCheckout()" class="block w-full bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white font-bold py-4 px-6 rounded-xl shadow-lg transform transition active:scale-95 mb-1 tracking-widest">
    UNLOCK NOW (Â¥150)
</button>

<div id="loading-msg" class="hidden text-xs text-cyan-400 animate-pulse mt-2 mb-6">
    Connecting to Stripe...
</div>

<button onclick="closePremiumModal()" class="text-slate-500 text-xs hover:text-white transition tracking-widest">
    CLOSE
</button>
    </div>
</div>
    <script>
    // --- è¨­å®šå€¤ ---
    const FREE_LIMIT = 50; // ç„¡æ–™ã§éŠã¹ã‚‹å˜èªæ•°
    let isUserPremium = false; // èª²é‡‘çŠ¶æ…‹ï¼ˆåˆæœŸå€¤falseï¼‰

    // list.htmlå°‚ç”¨ã®åˆæœŸåŒ–é–¢æ•°
    async function initializePage() {
        // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹å ´åˆã€UIã‚’æ›´æ–°
        if (currentUser) {
            updateUserUI(currentUser);
            // â˜…ã“ã“ã§Firestoreã‹ã‚‰èª²é‡‘çŠ¶æ…‹ã‚’å–å¾—ã™ã‚‹å‡¦ç†ãŒå…¥ã‚Šã¾ã™
            // ä»Šå›ã¯ä»®ã§ currentUser ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã« isPremium ãŒã‚ã‚‹ã¨ä»®å®šã€ãªã‘ã‚Œã° false
            // å°†æ¥çš„ã«ã¯: isUserPremium = await checkPremiumStatus(currentUser.uid);
            if (currentUser.isPremium) isUserPremium = true;
        }
        
        // å¸¸ã«æœ€æ–°ã®é€²æ—ã‚’èª­ã¿è¾¼ã‚“ã§ã‹ã‚‰ãƒªã‚¹ãƒˆã‚’æç”»
        await loadAllProgress();
        renderList();
    }

    function renderList() {
        const container = document.getElementById('list-container');
        const navContainer = document.getElementById('alphabet-nav-vertical');
        container.innerHTML = ''; // ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¯ãƒªã‚¢
        navContainer.innerHTML = ''; // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢

        let masteredCount = 0;

        // ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã”ã¨ã«å˜èªã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
        const groupedWords = WORD_DATABASE.reduce((acc, word) => {
            const firstLetter = word.word.charAt(0).toUpperCase();
            if (!acc[firstLetter]) {
                acc[firstLetter] = [];
            }
            acc[firstLetter].push(word);
            return acc;
        }, {});

        // ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †ã«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¨ã‚«ãƒ¼ãƒ‰ã‚’æç”»
        Object.keys(groupedWords).sort().forEach(letter => {
            // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒªãƒ³ã‚¯ã‚’ä½œæˆ
            const navLink = document.createElement('a');
            navLink.href = `#section-${letter}`;
            navLink.textContent = letter.toUpperCase();
            navLink.className = 'hover:text-cyan-400';
            navLink.onclick = (e) => {
                e.preventDefault();
                document.querySelector(navLink.getAttribute('href')).scrollIntoView({ behavior: 'smooth' });
            };
            navContainer.appendChild(navLink);

            // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä½œæˆ
            const sectionWrapper = document.createElement('div');
            sectionWrapper.id = `section-${letter}`;
            sectionWrapper.className = 'section-anchor';
            
            const header = document.createElement('h3');
            header.className = 'text-2xl font-black text-slate-600 tracking-widest mb-3 ml-1';
            header.textContent = letter;
            sectionWrapper.appendChild(header);
            
            // å„å˜èªã‚«ãƒ¼ãƒ‰ã‚’æç”»
            groupedWords[letter].forEach(word => {
                // â˜…ãƒ­ãƒƒã‚¯åˆ¤å®š
                const isLocked = (word.id > FREE_LIMIT) && !isUserPremium;

                // --- ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹å ´åˆã®è¡¨ç¤º ---
                if (isLocked) {
                    const div = document.createElement('div');
                    // å°‘ã—æš—ãã€å½©åº¦ã‚’è½ã¨ã—ãŸã‚¹ã‚¿ã‚¤ãƒ«
                    div.className = `word-card relative p-4 rounded-xl border border-slate-800 bg-slate-900/50 cursor-pointer transition-all overflow-hidden group mb-3 hover:border-purple-500/50`;
                    
                    // ã‚¯ãƒªãƒƒã‚¯ã§èª²é‡‘ãƒ¢ãƒ¼ãƒ€ãƒ«ã¸
                    div.onclick = () => openPremiumModal();

                    div.innerHTML = `
                        <div class="flex justify-between items-center relative z-10 opacity-60">
                            <div class="flex items-center gap-3">
                                <div class="text-xl text-slate-600">ğŸ”’</div>
                                <div>
                                    <div class="text-xl font-bold tracking-wide text-slate-500 filter blur-[2px] select-none">LOCKED</div>
                                    <div class="text-sm text-slate-600 jp-font mt-1">Premium Only</div>
                                </div>
                            </div>
                            <div class="text-right pl-4">
                                <div class="text-[10px] font-mono text-slate-700 mb-1 tracking-wider">ID</div>
                                <div class="text-lg font-bold font-mono text-slate-700">
                                    ${word.id}
                                </div>
                            </div>
                        </div>
                    `;
                    sectionWrapper.appendChild(div);

                // --- è§£æ”¾ã•ã‚Œã¦ã„ã‚‹å ´åˆï¼ˆæ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ï¼‰ ---
                } else {
                    const progress = getProgress(word.id);
                    let clearCount = 0;
                    if (typeof GAME_MODES !== 'undefined') {
                        clearCount = GAME_MODES.filter(m => progress[m.id]).length;
                    }

                    const isMastered = clearCount === 5;
                    if (isMastered) masteredCount++;

                    const progressPercent = (clearCount / 5) * 100;
                    
                    let borderClass = 'border-slate-700';
                    let bgClass = 'bg-slate-800';
                    let textClass = 'text-white';

                    if (isMastered) {
                        borderClass = 'border-cyan-500';
                        bgClass = 'bg-cyan-900/20';
                        textClass = 'text-cyan-300';
                    } else if (clearCount > 0) {
                        borderClass = 'border-slate-600';
                        bgClass = 'bg-slate-700/50';
                    }

                    const div = document.createElement('div');
                    div.className = `word-card relative p-4 rounded-xl border ${borderClass} ${bgClass} cursor-pointer transition-all overflow-hidden group mb-3`;
                    
                    div.onclick = () => goTo('cockpit.html', word.id);

                    div.innerHTML = `
                        <div class="flex justify-between items-center relative z-10">
                            <div>
                                <div class="text-xl font-bold tracking-wide ${textClass}">${word.word}</div>
                                <div class="text-sm text-gray-400 jp-font mt-1 line-clamp-1">${word.meaning_core}</div>
                            </div>
                            <div class="text-right pl-4">
                                <div class="text-[10px] font-mono text-gray-500 mb-1 tracking-wider">CLEAR</div>
                                <div class="text-lg font-bold font-mono ${isMastered ? 'text-cyan-400' : 'text-gray-600'}">
                                    ${clearCount}<span class="text-xs text-gray-600">/5</span>
                                </div>
                            </div>
                        </div>
                        <div class="absolute bottom-0 left-0 h-1 bg-gradient-to-r from-cyan-500 to-purple-500 transition-all duration-1000" style="width: ${progressPercent}%"></div>
                    `;
                    sectionWrapper.appendChild(div);
                }
            });

            container.appendChild(sectionWrapper);
        });

        // å…¨ä½“é€²æ—æ›´æ–°
        document.getElementById('total-progress').textContent = `${masteredCount} / ${WORD_DATABASE.length} MASTERED`;

        setupInteractiveNav();
    }

    function setupInteractiveNav() {
        const nav = document.getElementById('alphabet-nav-vertical');
        const links = Array.from(nav.getElementsByTagName('a'));
        if (links.length === 0) return;

        let activeLink = null;

        const updateActiveLink = (y) => {
            let closestLink = null;
            let minDistance = Infinity;

            links.forEach(link => {
                const linkRect = link.getBoundingClientRect();
                const linkCenterY = linkRect.top + linkRect.height / 2;
                const distance = Math.abs(y - linkCenterY);

                if (distance < minDistance) {
                    minDistance = distance;
                    closestLink = link;
                }
            });

            if (activeLink !== closestLink) {
                if (activeLink) {
                    activeLink.style.transform = 'scale(1)';
                    activeLink.style.color = '';
                }
                if (closestLink) {
                    closestLink.style.transform = 'scale(2.2)';
                    closestLink.style.color = '#22d3ee'; 
                }
                activeLink = closestLink;
            }
        };

        const resetStyles = () => {
            if (activeLink) {
                activeLink.style.transform = 'scale(1)';
                activeLink.style.color = '';
                activeLink = null;
            }
        };

        nav.addEventListener('mousemove', (e) => updateActiveLink(e.clientY));
        nav.addEventListener('mouseleave', resetStyles);
        nav.addEventListener('touchmove', (e) => { updateActiveLink(e.touches[0].clientY); }, { passive: true });
        nav.addEventListener('touchend', resetStyles);
    }

    // --- ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡ ---
    function openPremiumModal() {
        document.getElementById('premium-modal').classList.remove('hidden');
    }

    function closePremiumModal() {
        document.getElementById('premium-modal').classList.add('hidden');
    }

    // --- Stripeæ±ºæ¸ˆé–‹å§‹å‡¦ç† ---
async function startCheckout() {
    // ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
    if (!currentUser) {
        alert("Please login first to save your progress.");
        return;
    }

    const btn = document.getElementById('checkout-button');
    const msg = document.getElementById('loading-msg');
    
    // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã¦ãƒ­ãƒ¼ãƒ‰ä¸­è¡¨ç¤º
    btn.disabled = true;
    btn.classList.add('opacity-50', 'cursor-not-allowed');
    msg.classList.remove('hidden');

    try {
        // 1. Firestoreã«ã€Œã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆä¾é ¼ã€ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä½œã‚‹
        // æ‹¡å¼µæ©Ÿèƒ½ãŒã“ã‚Œã‚’æ¤œçŸ¥ã—ã¦ã€Stripeã®æ±ºæ¸ˆURLã‚’ç™ºè¡Œã—ã¦ãã‚Œã¾ã™
        const docRef = await db.collection('customers') // app.jsã§dbãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹å‰æ(firebase.firestore())
            .doc(currentUser.uid)
            .collection('checkout_sessions')
            .add({
                // â˜…é‡è¦: Stripeã®å•†å“ãƒšãƒ¼ã‚¸ã«ã‚ã‚‹ã€ŒAPI IDã€ã‚’ã“ã“ã«è²¼ã‚‹
                price: 'price_1SWfiz74xjWFgZZzeB2Zm8Xb', 
                success_url: window.location.href, // æˆåŠŸã—ãŸã‚‰ä»Šã®ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹
                cancel_url: window.location.href,
            });

        // 2. æ‹¡å¼µæ©Ÿèƒ½ãŒ url ã‚’æ›¸ãè¾¼ã‚“ã§ãã‚Œã‚‹ã®ã‚’å¾…ã¤
        docRef.onSnapshot((snap) => {
            const { error, url } = snap.data();
            if (error) {
                console.error('An error occurred:', error.message);
                alert('Error: ' + error.message);
                btn.disabled = false;
                msg.classList.add('hidden');
            }
            if (url) {
                // 3. URLãŒã§ããŸã‚‰ãã“ã«é£›ã°ã™ï¼ˆStripeæ±ºæ¸ˆç”»é¢ã¸ï¼‰
                window.location.assign(url);
            }
        });

    } catch (e) {
        console.error(e);
        alert("Checkout failed to start: " + e.message);
        btn.disabled = false;
        msg.classList.add('hidden');
    }
}
</script>

</body>
</html>